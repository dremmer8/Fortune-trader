rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isLegacyOwner(userId) {
      // Legacy ownership check: userId ends with _firebaseUid
      return isAuthenticated() &&
             userId.matches('.*_' + request.auth.uid + '$');
    }
    
    function isHashedOwner(userId) {
      // Stable ownership check: document ID equals gameUserId
      // Also allow legacy doc IDs that start with gameUserId + "_"
      return isAuthenticated() && (
        (resource != null && (
          resource.data.gameUserId == userId ||
          userId.matches('^' + resource.data.gameUserId + '_.+$')
        )) ||
        (request.resource != null && (
          request.resource.data.gameUserId == userId ||
          userId.matches('^' + request.resource.data.gameUserId + '_.+$')
        ))
      );
    }
    
    function isOwner(userId) {
      return isLegacyOwner(userId) || isHashedOwner(userId);
    }
    
    function isValidNumber(value, min, max) {
      return value is number && value >= min && value <= max;
    }
    
    // Users collection
    match /users/{userId} {
      // Read: only the owner can read their own data
      allow read: if isOwner(userId);
      
      // Delete: only the owner can delete their own data
      // Admin deletions must use Cloud Functions with proper authorization
      allow delete: if isOwner(userId);
      
      // Write: only the owner can write
      allow write: if isOwner(userId);
      
      // Update: only owner with validation (removed admin unflag from client rules)
      allow update: if isOwner(userId) &&
                       // Validate critical fields if they're being updated
                       (!('bankBalance' in request.resource.data) || 
                        isValidNumber(request.resource.data.bankBalance, 0, 1000000000)) &&
                       (!('balance' in request.resource.data) || 
                        isValidNumber(request.resource.data.balance, 0, 1000000000)) &&
                       (!('totalEarnings' in request.resource.data) || 
                        (isValidNumber(request.resource.data.totalEarnings, 0, 5000000000) &&
                         request.resource.data.totalEarnings >= resource.data.totalEarnings)) &&
                       (!('tradingRounds' in request.resource.data) || 
                        (isValidNumber(request.resource.data.tradingRounds, 0, 250000) &&
                         request.resource.data.tradingRounds >= resource.data.tradingRounds)) &&
                       (!('timestamp' in request.resource.data) || 
                        (request.resource.data.timestamp is number &&
                         request.resource.data.timestamp <= request.time.toMillis() + 60000));
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
